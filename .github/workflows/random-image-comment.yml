name: Random Image Comment

on:
  pull_request:
    types: [opened]

jobs:
  comment-random-image:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch random image and comment on PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # APIã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ç”»åƒã‚’å–å¾—
          API_URL="https://kotonoha.sh1ma.dev/api/photos/random?userId=google-oauth2|108347409698494459380"

          echo "Fetching random image from: $API_URL"
          RESPONSE=$(curl -s "$API_URL")

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
          echo "API Response: $RESPONSE"

          # okãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          OK=$(echo "$RESPONSE" | jq -r '.ok')

          if [ "$OK" != "true" ]; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"')
            echo "::error::API error: $ERROR"
            exit 1
          fi

          # ç”»åƒURLã¨é–¢é€£æƒ…å ±ã‚’å–å¾—
          IMAGE_URL=$(echo "$RESPONSE" | jq -r '.photo.imageUrl')
          TWEET_URL=$(echo "$RESPONSE" | jq -r '.photo.tweetUrl // empty')
          TWEET_AUTHOR=$(echo "$RESPONSE" | jq -r '.photo.tweetAuthorScreenName // empty')

          if [ -z "$IMAGE_URL" ] || [ "$IMAGE_URL" = "null" ]; then
            echo "::error::ç”»åƒURLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi

          echo "Image URL: $IMAGE_URL"
          echo "Tweet URL: $TWEET_URL"
          echo "Tweet Author: $TWEET_AUTHOR"

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          COMMENT="## ğŸ¨ ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ ç”»åƒ

![Random Image]($IMAGE_URL)"

          # ãƒ„ã‚¤ãƒ¼ãƒˆæƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
          if [ -n "$TWEET_URL" ] && [ "$TWEET_URL" != "null" ]; then
            COMMENT="$COMMENT

---"
            if [ -n "$TWEET_AUTHOR" ] && [ "$TWEET_AUTHOR" != "null" ]; then
              COMMENT="$COMMENT

ğŸ“¸ Photo by [@$TWEET_AUTHOR](https://twitter.com/$TWEET_AUTHOR)
ğŸ”— [å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹]($TWEET_URL)"
            else
              COMMENT="$COMMENT

ğŸ”— [å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹]($TWEET_URL)"
            fi
          fi

          COMMENT="$COMMENT

---

*PRä½œæˆãŠç–²ã‚Œæ§˜ã§ã™ï¼*"

          echo "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body-file -

          echo "âœ… ãƒ©ãƒ³ãƒ€ãƒ ç”»åƒã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
