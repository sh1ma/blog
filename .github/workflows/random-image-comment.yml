name: Random Image Comment

on:
  pull_request:
    types: [opened]

permissions:
  pull-requests: write
  contents: read

jobs:
  comment-random-image:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch random image and comment on PR
        env:
          GH_TOKEN: ${{ github.token }}
          # ãƒ©ãƒ³ãƒ€ãƒ ç”»åƒAPIç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆãƒªãƒã‚¸ãƒˆãƒªå¤‰æ•°ã¨ã—ã¦è¨­å®šæ¨å¥¨ï¼‰
          RANDOM_IMAGE_USER_ID: ${{ vars.RANDOM_IMAGE_USER_ID || 'google-oauth2%7C108347409698494459380' }}
        run: |
          # APIã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ç”»åƒã‚’å–å¾—
          # æ³¨: jqã‚³ãƒãƒ³ãƒ‰ã¯ubuntu-latestãƒ©ãƒ³ãƒŠãƒ¼ã«æ¨™æº–è£…å‚™ã•ã‚Œã¦ã„ã¾ã™
          API_URL="https://kotonoha.sh1ma.dev/api/photos/random?userId=${RANDOM_IMAGE_USER_ID}"

          echo "Fetching random image from: $API_URL"
          # -f ãƒ•ãƒ©ã‚°ã§HTTPã‚¨ãƒ©ãƒ¼ï¼ˆ4xx, 5xxï¼‰ã‚’æ¤œå‡º
          if ! RESPONSE=$(curl -fs "$API_URL"); then
            echo "::error::Failed to fetch image from API (HTTP error or network failure)"
            exit 1
          fi

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
          echo "API Response: $RESPONSE"

          # okãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          OK=$(echo "$RESPONSE" | jq -r '.ok')

          if [ "$OK" != "true" ]; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"')
            echo "::error::API error: $ERROR"
            exit 1
          fi

          # ç”»åƒURLã¨é–¢é€£æƒ…å ±ã‚’å–å¾—
          IMAGE_URL=$(echo "$RESPONSE" | jq -r '.photo.imageUrl')
          TWEET_URL=$(echo "$RESPONSE" | jq -r '.photo.tweetUrl // empty')
          TWEET_AUTHOR=$(echo "$RESPONSE" | jq -r '.photo.tweetAuthorScreenName // empty')

          if [ -z "$IMAGE_URL" ] || [ "$IMAGE_URL" = "null" ]; then
            echo "::error::ç”»åƒURLã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi

          echo "Image URL: $IMAGE_URL"
          echo "Tweet URL: $TWEET_URL"
          echo "Tweet Author: $TWEET_AUTHOR"

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ï¼ˆãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼‰
          cat << 'EOF' > /tmp/pr-comment.md
          ## ğŸ¨ ä»Šæ—¥ã®ãƒ©ãƒ³ãƒ€ãƒ ç”»åƒ

          ![Random Image](IMAGE_URL_PLACEHOLDER)
          EOF

          # ç”»åƒURLã‚’ç½®æ›
          sed -i "s|IMAGE_URL_PLACEHOLDER|$IMAGE_URL|g" /tmp/pr-comment.md

          # ãƒ„ã‚¤ãƒ¼ãƒˆæƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
          if [ -n "$TWEET_URL" ] && [ "$TWEET_URL" != "null" ]; then
            cat << 'EOF' >> /tmp/pr-comment.md

          ---
          EOF
            if [ -n "$TWEET_AUTHOR" ] && [ "$TWEET_AUTHOR" != "null" ]; then
              echo "" >> /tmp/pr-comment.md
              echo "ğŸ“¸ Photo by [@$TWEET_AUTHOR](https://x.com/$TWEET_AUTHOR)" >> /tmp/pr-comment.md
              echo "ğŸ”— [å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹]($TWEET_URL)" >> /tmp/pr-comment.md
            else
              echo "" >> /tmp/pr-comment.md
              echo "ğŸ”— [å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹]($TWEET_URL)" >> /tmp/pr-comment.md
            fi
          fi

          # æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
          cat << 'EOF' >> /tmp/pr-comment.md

          ---

          *PRä½œæˆãŠç–²ã‚Œæ§˜ã§ã™ï¼*
          EOF

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body-file /tmp/pr-comment.md

          echo "âœ… ãƒ©ãƒ³ãƒ€ãƒ ç”»åƒã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
